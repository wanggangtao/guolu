<?php/** * Created by PhpStorm. * User: sxm * Date: 2019/3/4 * Time: 17:32 */try {    $page = isset($_POST['page'])?safeCheck($_POST['page']):1;    $pageSize  = isset($_POST['pageSize'])?safeCheck($_POST['pageSize']):15;    $keyword  = isset($_POST['keyword'])?safeCheck($_POST['keyword'],0):'';    if(empty($uid)) throw new MyException("缺少用户uid参数",411);    /**判断是否在公司大群里面****/    $attrs = array();    if(!empty($keyword))    {        $attrs["keyword"] = $keyword;    }    chat_room_msg_config::checkFromFirstRoom($uid);    $userInfo = User::getInfoById($uid);    $new_count = 0;    $num = 0;    if ($userInfo['role']==2||$userInfo['role']==4){        $dataItem = Chat_room::getListByUd($uid,0,$attrs,1,1);        $dataItem[0]['last_msg_addtime'] = getDateStr($dataItem[0]['last_msg_addtime']);        $dataItem[0]['addtime'] = getDateStr($dataItem[0]['addtime']);        $first_count =  $dataItem[0]['new_count'];        $resultArray['data'] = $dataItem;        $user_list = User::getRoleInfoByDepartment($userInfo['department'],1);        if ($userInfo['role']==2) {            $userItem['id'] = $userInfo['id'];            $userItem['name'] = $userInfo['name'];            $count_Item = Chat_room::getListByUd($uid, $uid, $attrs, 0, 0);            foreach ($count_Item as $Item) {                $num += $Item['new_count'];            }            $userItem['new_count'] = $num;            $data[] = $userItem;        }        foreach ($user_list as $item){            $count = 0;            $dataItem = array();            $dataItem['id'] = $item['id'];            $dataItem['name'] = $item['name'];            $countItem = Chat_room::getListByUd($uid,$item['id'],$attrs,0,0);            foreach ($countItem as $Item){                $count +=$Item['new_count'];            }            $dataItem['new_count'] = $count;            $new_count+=$count;            $data[] = $dataItem;        }        $resultArray['user'] = $data;        $resultArray['count'] = $new_count+$num+$first_count;    }else{        $dataItem = Chat_room::getListByUd($uid,0,$attrs,1,1);        $dataItem[0]['last_msg_addtime'] = getDateStr($dataItem[0]['last_msg_addtime']);        $dataItem[0]['addtime'] = getDateStr($dataItem[0]['addtime']);        $first_count =  $dataItem[0]['new_count'];        $resultArray['data'] = $dataItem;        $user_list = User::getRole();        $userItem['id'] = $userInfo['id'];        $userItem['name'] = $userInfo['name'];        $count_Item = Chat_room::getListByUd($uid,$uid,$attrs,0,0);        foreach ($count_Item as $Item){            $num +=$Item['new_count'];        }        $userItem['new_count'] = $num;        $data[] = $userItem;        foreach ($user_list as $item){            $count = 0;            $dataItem = array();            $dataItem['id'] = $item['id'];            $dataItem['name'] = $item['name'];            $countItem = Chat_room::getListByUd($uid,$item['id'],$attrs,0,0);            foreach ($countItem as $Item){                $count +=$Item['new_count'];            }            $dataItem['new_count'] = $count;            $new_count+=$count;            $data[] = $dataItem;        }        $resultArray['user'] = $data;        $resultArray['count'] = $new_count+$num+$first_count;    }    echo action_msg_data(API::SUCCESS_MSG, API::SUCCESS, $resultArray);}catch (MyException $e){    $api->ApiError($e->getCode(), $e->getMessage());}