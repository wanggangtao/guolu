<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="format-detection" content="telephone=yes" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0,maximum-scale=1.0, user-scalable=no" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <meta content="black" name="apple-mobile-web-app-status-bar-style">
    <meta content="telephone=no" name="format-detection">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>订单详情</title>
    <link rel="stylesheet" href="weui/css/weui.min.css" />
    <link rel="stylesheet" href="weui/css/jquery-weui.min.css" />
    <link rel="stylesheet" href="css/common.css">
    <script src="js/rem.js" async="async"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue"></script>
</head>

<style>
    html,
    body {
        background: rgba(243, 243, 243, 1);
    }


    body :nth-child(4) img {
        float: right;
        width: .4rem;
        height: .4rem;
    }


    .btn-group {
        display: flex;
        justify-content: space-around;
        margin: 0.4rem .6rem 0 .5rem;
    }

    .btn-group button {
        padding: 0 0.2rem 0 0.2rem;
        width: 1.6rem;
        line-height: 0.6rem;
    }
</style>

<body>
    <div class="cancell-confirm">
        <div class="close-mask"><img src="images/hd-close.png" alt=""></div>
        <p>确定要删除该订单吗？</p>
        <div class="btn-group"><button class="assess" style="margin: 0">确定</button></div>
    </div>
    <div class="mask"></div>
    <div id="vue-content">
        <div class="top-tab">
            <p><a href="#" onClick="javascript :history.back(-1);"><img src="images/icon-bark.png"></a></p>
            <p style="text-align: center">订单详情</p>
            <p></p>
        </div>

        <div class="wrap">
            <div class="info ">
                <img src="images/repair_complete.png" alt="图片">
                <div>
                    <p id="repair-statu">加载中</p>
                    <p id="repair-result">&nbsp;</p>
                </div>
            </div>
        </div>


    </div>
    <!-- 售后信息 -->
    <div class="wrap">
        <div class="title cells">
            <img src="images/aftersale_info.png" alt="">
            <span>售后信息</span>
        </div>
        <div class="content">
            <div class="row">
                本订单由西安元聚提供售后保障服务。维修完成后针对故障点质保180天。
            </div>

        </div>
    </div>
    <!-- 保修时间 -->
    <div class="wrap period" style="background:rgba(209,242,255,1);font-size:.28rem;height:.66rem;padding: 0;line-height: .66rem;
font-weight:600;
color:rgba(4,166,254,1);
text-align: center">
        
    </div>
    <div class="btn-group" style="justify-content: flex-end;margin: .2rem 2% .2rem 0">

        <!-- 
                        
                       <a href="order_detail.html?${DB[i].id}"><button>订单详情</button></a>
                       <a href="cancell_order.html?${DB[i].id}" style="display: none"><button class="btn-cancell">取消订单</button></a>
                       
                        -->
    </div>
    <!-- 提示框 -->
    <div id="toast" style="display: none;">
        <div class="weui-mask_transparent"></div>
        <div class="weui-toast">
            <!-- <i class="weui-icon-success-no-circle weui-icon_toast"></i> -->
            <p class="weui-toast__content" style="margin: 0"></p>
        </div>
    </div>

</body>
<script src="js/jquery.min.js"></script>
<script src="weui/js/jquery-weui.min.js"></script>
<script>
    console.log(location.search.substr(1));
    var id = location.search.substr(1)
    var data

    $(function () {
        $.ajax({
            type: 'POST',
            url: 'http://boiler.xazhima.com/api/v1.0/api_weixin_order_detail.php',
            data: {
                id: id,
            },
            success: function (res) {
                data = JSON.parse(res).data
                console.log(data);
                xuanran(data);
            },

        })
    })
    $('.cancell-confirm .btn-group button').click(function () {
        console.log(del_id);
        $.ajax({
            type: 'POST',
            url: 'http://boiler.xazhima.com/weixin/review_do.php',
            data: {
                act: 'del',
                id: del_id
            },
            success: function (res) {
                console.log(res)
                $(".mask").hide()
                $(".cancell-confirm").hide()
                toast('删除成功')
                setTimeout(function () {
                    location.reload();
                }, 700)
            }
        })
    })
    //删除订单触发按钮
    $('#tab0').on('click', '.btn-del', function () {
        del_id = $(this)[0].dataset.delflag
        $(".mask").show()
        $(".cancell-confirm").css('display', 'flex');
    })

    function xuanran(data) {
        $('#vue-content').append(
            `
                        <div class="wrap">
            <div class="title cells">
                <img src="images/order_info.png" alt="">
                <span>订单信息</span>
            </div>
            <div class="content">
                <div class="row">
                    <div>订单号</div>
                    <div>${data.pay_num}</div>
                </div>
                <div class="row">
                    <div>产品品牌</div>
                    <div>${data.brand}</div>
                </div>
                <div class="row">
                    <div>产品型号</div>
                    <div>${data.bar_code}</div>
                </div>
                <div></div>
                <div class="row">
                    <div>联系人</div>
                    <div>${data.register_person}</div>
                </div>
                <div class="row">
                    <div>联系电话</div>
                    <div>${data.register_phone}</div>
                </div>
                <div></div>
                <div class="row">
                    <div>联系地址</div>
                    <div>${data.address_all}</div>
                </div>
                <div class="row">
                    <div>服务类型</div>
                    <div>故障报修</div>
                </div>
                <div class="row">
                    <div>故障详情</div>
                    <div>${data.failure_cause}</div>
                </div>
                <div class="row">
                    <div>下单时间</div>
                    <div>${data.addtime}</div>
                </div>
            </div>
        </div>
                        `
        )
        //保修信息渲染
        $('.period').append(`<p>保修截止日期：${data.prodect.period}</p>
        `)
        if (data.child_status == '31') {
            $('#repair-statu').text('已取消')
            $('#repair-result').text('此次维修服务已取消')
            $('.btn-group').append(
                `
                <button class="btn-del" data-delflag="${data.id}">删除订单</button>
                `
            )
            console.log('已取消');
            return;
        }
        if (data.child_status == '11' || data.child_status == '12' || data.child_status == '21') {
            $('#repair-statu').text('已下单')

            $('#repair-result').text('您已成功预约服务')
            console.log('asdasdas');
            $('.btn-group').append(
                `
                <a href="cancell_order.html?${data.id}"><button class="btn-cancell">取消订单</button></a>
                `
            )
            console.log('已下单');
            return;
        }


        $('#vue-content').append(
            `
                        <div class="wrap">
            <div class="title cells">
                <img src="images/engineering_info.png" alt="">
                <span>工程师信息</span>
            </div>
            <div class="content">
                <p><span style="margin: 0 .4rem 0 0;
                color: rgba(159, 159, 159, 1);">工程师&emsp;</span>${data.person.name}<span style="margin: 0 .4rem 0 0;
                color: rgba(159, 159, 159, 1);">&emsp;工号</span>${data.person.id}<a href="tel:${data.linkphone}"><img
                            src="images/icon-tell.png"></a></p>
            </div>
        </div>
                        `

        )
        if (data.child_status == '22') {
            $('#repair-statu').text('已接单')
            $('#repair-result').text('维修师傅已接单，请保持电话畅通')
            console.log('已接单');
            return;
        }

        $('#vue-content').append(
            `
            <div class="wrap">
            <div class="title cells">
                <img src="images/order_info.png" alt="">
                <span>维修信息</span>
            </div>
            <div class="content">
                <div class="row">
                    <div>维修情况</div>
                    <div>${data.result ? data.result : `暂无`}</div>
                </div>
                <div class="row">
                    <div>使用配件</div>
                    <div class="detail-parts"></div>
                </div>
                <div class="row">
                    <div>上传图片</div>
                    <div>${data.picture_url ? `<img src="http://boiler.xazhima.com${data.picture_url}" alt="asd">` : `<div style="font-weight:400;color:rgba(34,34,44,1)">暂无图片</div>`}  </div>
                </div>
                <div class="row">
                    <div>维修金额</div>
                    <div>维修费：${data.repair_hand_money}元，配件金额：${data.repair_part_money}元 合计：${parseInt(data.repair_hand_money)+parseInt(data.repair_part_money)}元</div>
                </div>
            </div>
        </div>
        <!-- 支付信息 -->
        <div class="wrap">
            <div class="title cells">
                <img src="images/pay_info.png" alt="">
                <span>支付信息</span>
            </div>
            <div class="content">
                <div class="row">
                    <div>支付金额</div>
                    <div>${data.sum_money}</div>
                </div>
                <div class="row">
                    <div>支付情况</div>
                    <div id="pay-statu">已支付</div>
                </div>
            </div>
        </div>
                        `
        )
        if (data.part) {
            for (let i = 0; i < data.part.length; i++) {
                $('.detail-parts').append(
                `
                ${data.part[i].name}配件 数量：${data.part[i].num}个 金额：${data.part[i].price}元
                `)
            }
        } else {
            $('.detail-parts').append(
                `
                未使用配件`)
        }
        
        if (data.child_status == '23') {
            $('#repair-statu').text('待支付')
            $('#repair-result').text('您预约的“故障报修”服务，已维修完成，请您尽快支付')
            $('#pay-statu').text('未支付')

            $('.btn-group').append(
                `
                <a href="../weixin/order_gopay.php?id=${data.id}"><button class="blue-btn">去付款</button></a>
                `)
            console.log('待支付');
        }


        if (data.child_status == '32' || data.child_status == '33') {
            $('#repair-statu').text('已完工')
            $('#repair-result').text('此次维修服务已确认完成，感谢您！')
            if (data.user_evaluation!=='-1') {
                $('#vue-content').append(
                    `
                        <div class="wrap">
            <div class="title cells">
                <img src="images/order_info.png" alt="">
                <span>评价信息</span>
            </div>
            <div class="content">
                <div class="row">
                    ${data.user_evaluation}
                </div>
            </div>
        </div>
                        `
                )
            } else {
                $('.btn-group').append(
                    `
                <a href="comment.html?${data.id}"><button class="blue-btn">去评价</button></a>
                `
                )
                console.log('已完工');

            }


        }
        
    }


</script>
<script>
// 对浏览器的UserAgent进行正则匹配，不含有微信独有标识的则为其他浏览器
// var useragent = navigator.userAgent;
// if(useragent.match(/WindowsWechat/) == 'WindowsWechat' || useragent.match(/MicroMessenger/i) != 'MicroMessenger') {
//     // 这里警告框会阻塞当前页面继续加载

//     document.head.innerHTML = '<title>抱歉，出错了</title><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0"><link rel="stylesheet" type="text/css" href="https://res.wx.qq.com/open/libs/weui/0.4.1/weui.css">';
//     document.body.innerHTML = '<div class="weui_msg"><div class="weui_icon_area"><i class="weui_icon_info weui_icon_msg"></i></div><div class="weui_text_area"><h4 class="weui_msg_title">请在微信客户端打开链接</h4></div></div>';
// }
</script>



</html>